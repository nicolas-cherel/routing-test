montageDefine("579d289","router",{dependencies:["montage/core/core","montage/ui/component","montage/frb/observe","montage/frb/evaluate","montage/frb/assign","montage/core/logger"],factory:function(e,t){var n=e("montage/core/core").Montage,o=(e("montage/ui/component").Component,e("montage/frb/observe")),a=(e("montage/frb/evaluate"),e("montage/frb/assign")),r=e("montage/core/logger").logger("component");t.Routable=n.specialize({constructor:{value:function(){this.super(),this.state={}}},deserializedFromSerialization:{value:function(){var e=this.target.rootComponent.router;Object.keys(this.state).forEach(function(t){o(this,"state."+t,{components:this.labeler,change:function(){e.notifyRoutableStateChange(this,t)}.bind(this)})},this)}},component:{value:null},routablePropertiesMap:{value:null},state:{value:null},_labeler:{value:null},labeler:{get:function(){return this._labeler||(this._labeler={getObjectByLabel:function(e){return this.target.templateObjects[e]}.bind(this)})}},applyPropertyState:{value:function(e,t){a(this,"state."+e,t)}}}),t.Router=n.specialize({constructor:{value:function(){this.super(),this._routingObjectsTable={}}},stateKey:{value:"state"},_root:{value:null},hook:{set:function(e){if(this._root=e.rootComponent,this._root.router)throw Error("oops, root component already has a router");this._root.router=this}},deserializedFromSerialization:{value:function(){var e=null;if(e=localStorage.getItem(this.stateKey))try{var t=JSON.parse(e);this.applyAppState(this._root,t)}catch(n){r.debug(n),r.debug("could not restore application state")}}},applyStateToComponent:{value:function(e,t){Object.keys(e).forEach(function(n){t.routable.applyPropertyState(n,e[n])})}},__isRoutingInProgress:{value:null},applyAppState:{value:function(e,t){this.__isRoutingInProgress=!0;for(var n=[[e,t]],a=null;a=n.pop();){var e=a[0],r=a[1];if(r.state&&e.routable&&this.applyStateToComponent(r.state,e),r.children){r.children.length;var i=this;Object.keys(r.children).forEach(function(t){var a=r.children[t],l=null;if("#"===t[0]?(index=parseInt(t.slice(1),10),0/0!==index&&(l=e.childComponents[index])):l=e.templateObjects[t],l)n.push([l,a]);else var s=o(e,"childComponents.length",function(){e.childComponents.forEach(function(e){(e.routableName||e.identifier)===t&&(i.applyAppState(e,a),s())})})})}}this.__isRoutingInProgress=!1}},notifyRoutableStateChange:{value:function(e){this.__isRoutingInProgress||(this.updateEntry(e.target),this.saveRoutableState())}},updateEntry:{value:function(e){if(e.routable){var t=this.getEntry(e);return t.state=e.routable.state,t}}},fetchRoutableState:{value:function(){for(var e=this,t={comp:this._root,routable:!0,parent:null,children:[]},n=[t],o=null;o=n.pop();)e.updateEntry(o.comp),n.splice.apply(n,[0,0].concat(o.comp.childComponents.map(function(e){var t={comp:e,id:e.routableName||e.identifier,children:[],routable:!!e.routable,parent:o};if(e.routable)for(var n=e;(n=n.parent)&&!n.routable;)n.routable=!0;return o.children.push(t),t})));n=[t];for(var o=null;o=n.pop();){var a=o.children.reduce(function(e,t,n){return t.routable||e.push(n),e},[]);a.reverse().forEach(function(e){o.children.splice(e,1)});var i=o.comp;delete o.comp,delete o.parent,delete o.routable,delete o.id,o.state=this.getEntry(i).state,n.splice.apply(n,[0,0].concat(o.children));var l=o.children;0===l.length?delete o.children:(o.children={},l.forEach(function(e,t){var n=e.id||"#"+t.toString(10);n in o.children&&r.debug("conflicting key ",n,"in routable children"+e.id),o.children[n]=e}))}return t}},saveRoutableState:{value:function(){var e=this.fetchRoutableState();localStorage.setItem("state",JSON.stringify(e))}},getEntry:{value:function(e){return e.uuid in this._routingObjectsTable?this._routingObjectsTable[e.uuid]:this._routingObjectsTable[e.uuid]={component:e}}}})}});