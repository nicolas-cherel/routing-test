var Promise=require("./promise").Promise;exports=module.exports=function(e){e=exports.normalizeRequest(e);var t=Promise.defer(),n=e.xhr||new XMLHttpRequest;n.open(e.method,e.url,!0),n.onload=function(){var e={status:n.status,headers:exports.parseResponseHeaders(n.getAllResponseHeaders()),body:n.response,xhr:n};t.resolve(e)},n.onerror=function(){t.reject(Error("Could not load"))};var r=e.headers;for(var i in r){var o=r[i];if(Array.isArray(o))for(var a=0;o.length>a;a++)n.setRequestHeader(i,o[a]);else n.setRequestHeader(i,o)}var s=e.options;for(var l in s)n[l]=s[l];return e.overrideMimeType&&n.overrideMimeType(e.overrideMimeType),n.send(e.body),t.promise},exports.request=exports,exports.makeOk=function(e){return function(t){t=exports.normalizeRequest(t);var n=t.url;return Promise.when(e(t),function(e){if(e.status>=200&&300>e.status)return e;var t=Error("Could not load "+JSON.stringify(n)+": "+e.status+" "+e.xhr.statusText);throw t.response=e,t})}},exports.ok=exports.makeOk(exports.request),exports.makeJson=function(e){return function(t){t=exports.normalizeRequest(t);var n=t.url;return t.headers.accept=t.headers.accept||"application/json",t.headers["content-type"]=t.headers["content-type"]||"application/json","object"==typeof t.body&&(t.body=JSON.stringify(t.body)),t.overrideMimeType=t.overrideMimeType||"application/json",t.options.responseType=t.options.responseType||"json",Promise.when(e(t),function(e){if(null===e.body||"string"==typeof e.body)try{e.body=JSON.parse(e.body)}catch(t){throw Error("Could not parse JSON from "+JSON.stringify(n)+": "+t.message)}return e})}},exports.json=exports.makeJson(exports.request),exports.normalizeRequest=function(e){return"string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.options=e.options||{},e},exports.parseResponseHeaders=function(e){var t={};return e?(e.replace(/^([^:]+):(.*)$/gm,function(e,n,r){n=n.trim().toLowerCase(),r=r.trim(),n in t?("string"==typeof t[n]&&(t[n]=[t[n]]),t[n].push(r)):t[n]=r}),t):t};